name: MongoDB PHI Masker Tests

on:
  push:
    branches: [main, develop, "feat/mongo-phi-masker-*"]
    paths:
      - "mongo_phi_masker/**"
      - ".github/workflows/mongo-phi-masker-tests.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "mongo_phi_masker/**"
      - ".github/workflows/mongo-phi-masker-tests.yml"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  WORKING_DIR: "mongo_phi_masker"

jobs:
  test:
    name: Test PHI Masker (${{ matrix.os }} / Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11", "3.12"]

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "${{ env.WORKING_DIR }}/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install common_config (monorepo dependency)
        run: |
          pip install -e ../common_config || echo "common_config not found, skipping"

      - name: Create test artifacts directory
        run: |
          mkdir -p artifacts/coverage artifacts/test-reports

      - name: Run unit tests
        run: |
          pytest tests/ \
            --verbose \
            --maxfail=1 \
            --tb=short \
            -m "unit" \
            --cov=src \
            --cov=masking \
            --cov-report=xml:artifacts/coverage/coverage.xml \
            --cov-report=html:artifacts/coverage/htmlcov \
            --cov-report=term-missing \
            --junitxml=artifacts/test-reports/junit.xml
        env:
          PYTEST_MARKERS: "unit"

      - name: Display coverage summary
        if: always()
        run: |
          if [ -f artifacts/coverage/coverage.xml ]; then
            echo "Coverage report generated successfully"
            cat artifacts/coverage/coverage.xml | grep -A 5 'line-rate' || true
          fi

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./mongo_phi_masker/artifacts/coverage/coverage.xml
          flags: mongo-phi-masker
          name: mongo-phi-masker-coverage
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ${{ env.WORKING_DIR }}/artifacts/test-reports/

      - name: Upload coverage reports
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: ${{ env.WORKING_DIR }}/artifacts/coverage/

  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black ruff pyright

      - name: Check formatting with Black
        run: |
          black --check --diff .

      - name: Lint with Ruff
        run: |
          ruff check .

      - name: Type check with Pyright (informational)
        run: |
          pyright || true
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit pip-audit

      - name: Run Safety check
        run: |
          safety check --json || true
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip-audit --desc || true
        continue-on-error: true

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -f json -o ../artifacts/bandit-report.json || true
        continue-on-error: true

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test CLI help command
        run: |
          python run.py --help

      - name: Test CLI info command
        run: |
          python run.py info

      - name: Verify module imports
        run: |
          python -c "from src.core.masker import DocumentMasker; print('✓ DocumentMasker import OK')"
          python -c "from src.core.connector import MongoConnector; print('✓ MongoConnector import OK')"
          python -c "from src.models.masking_rule import MaskingRule; print('✓ MaskingRule import OK')"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, lint, security, smoke-test]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Smoke Test: ${{ needs.smoke-test.result }}"

      - name: Report status
        if: |
          needs.test.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.smoke-test.result == 'failure'
        run: |
          echo "❌ mongo_phi_masker tests failed - check logs above"
          exit 1

      - name: Success message
        if: |
          needs.test.result == 'success' &&
          needs.lint.result == 'success' &&
          needs.smoke-test.result == 'success'
        run: |
          echo "✅ All mongo_phi_masker tests passed successfully!"
